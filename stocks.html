<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>è²¨å­˜</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="background-image"></div>
    <div class="overlay"></div>
    <div class="container">
        <div class="stocks-header">
            <h1>è²¨å­˜</h1>
            <button class="refresh-btn" id="refreshBtn" onclick="fetchStocksData()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="stocks-container" id="stocksContainer">
            <div class="loading-message" id="loadingMessage">
                <p>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            <div class="stocks-table-wrapper" id="stocksTableWrapper" style="display: none;">
                <table class="stocks-table" id="stocksTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>é¡åˆ¥</th>
                            <th>æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody id="stocksTableBody">
                        <!-- Data will be dynamically generated -->
                    </tbody>
                </table>
            </div>
            <div class="no-data-message" id="noDataMessage" style="display: none;">
                <p>ç›®å‰æ²’æœ‰æ•¸æ“šè¨˜éŒ„</p>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #ccc; text-align: center;">
                    è«‹ç¢ºä¿æ‚¨çš„ Google Apps Script å·²é…ç½®ç‚ºæ”¯æŒæ•¸æ“šè®€å–åŠŸèƒ½ã€‚
                </p>
            </div>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">â¬…ï¸ è¿”å›</button>
    </div>

    <script>
        // Google Apps Script API URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbz8DWvcfhl0ao0PCJ0DkGLRpKtZ0G89HM1WkJVyZcQfNES5aNHHJ9gAdsVoMbvqcDrJ/exec';
        
        const loadingMessage = document.getElementById('loadingMessage');
        const noDataMessage = document.getElementById('noDataMessage');
        
        // Function to animate progress bar
        function animateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (!progressBar) return;
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) {
                    progress = 90; // Stop at 90% until data loads
                }
                progressBar.style.width = progress + '%';
            }, 200);
            
            // Store interval ID for cleanup
            progressBar.dataset.intervalId = interval;
        }
        
        // Function to complete progress bar
        function completeProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (progressBar && progressBar.dataset.intervalId) {
                clearInterval(parseInt(progressBar.dataset.intervalId));
            }
            if (progressBar) {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                }, 300);
            }
        }
        
        // Function to fetch data from Google Sheets using JSONP
        function fetchStocksData() {
            // Show loading message
            loadingMessage.style.display = 'block';
            const stocksTableWrapper = document.getElementById('stocksTableWrapper');
            if (stocksTableWrapper) stocksTableWrapper.style.display = 'none';
            noDataMessage.style.display = 'none';
            
            // Reset and start progress bar animation
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            animateProgressBar();
            
            // Create a unique callback function name with timestamp to prevent caching
            const timestamp = Date.now();
            const callbackName = 'handleStocksData_' + timestamp;
            
            // Create the callback function
            window[callbackName] = function(data) {
                // Complete progress bar
                completeProgressBar();
                
                // Clean up
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
                
                // Display the data
                if (data && (Array.isArray(data) || (data.data && Array.isArray(data.data)))) {
                    displayStocksData(data);
                } else {
                    showNoData();
                }
            };
            
            // Create script tag for JSONP with timestamp to prevent caching
            const script = document.createElement('script');
            script.src = scriptURL + '?action=get&callback=' + callbackName + '&_t=' + timestamp;
            script.onerror = function() {
                // Complete progress bar on error
                completeProgressBar();
                
                // Clean up on error
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                // Try alternative method
                fetchStocksDataAlternative();
            };
            
            document.head.appendChild(script);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                completeProgressBar();
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                if (window[callbackName]) {
                    delete window[callbackName];
                    fetchStocksDataAlternative();
                }
            }, 10000);
        }
        
        // Alternative method: Try direct fetch (may not work due to CORS)
        async function fetchStocksDataAlternative() {
            try {
                // Add timestamp to prevent caching
                const timestamp = Date.now();
                // Try to fetch as text first (to bypass CORS issues)
                const response = await fetch(scriptURL + '?action=get&_t=' + timestamp, {
                    method: 'GET',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                // Since no-cors doesn't allow reading response, we'll show instructions
                showNoDataWithInstructions();
            } catch (error) {
                console.error('Error fetching data:', error);
                showNoDataWithInstructions();
            }
        }
        
        // Function to display stocks data
        function displayStocksData(data) {
            completeProgressBar();
            loadingMessage.style.display = 'none';
            
            // Handle different data formats
            let dataArray = [];
            if (Array.isArray(data)) {
                dataArray = data;
            } else if (data.data && Array.isArray(data.data)) {
                dataArray = data.data;
            } else if (data.rows && Array.isArray(data.rows)) {
                dataArray = data.rows;
            }
            
            if (dataArray.length === 0) {
                showNoData();
                return;
            }
            
            const stocksTableBody = document.getElementById('stocksTableBody');
            const stocksTableWrapper = document.getElementById('stocksTableWrapper');
            
            if (!stocksTableBody || !stocksTableWrapper) return;
            
            stocksTableBody.innerHTML = '';
            stocksTableWrapper.style.display = 'block';
            
            // Create table rows for ID, category, and quantity
            dataArray.forEach((row, index) => {
                // Handle different data formats from Google Sheets
                let id, category, quantity;
                
                if (typeof row === 'object' && !Array.isArray(row)) {
                    // Object format from doGet function
                    // Get all keys to find ID, category, and quantity columns
                    const keys = Object.keys(row);
                    
                    // Try to find ID, category, and quantity by common column names
                    id = row.ID || row['ID'] || row.id || row['id'] || row['ID'] || row['ç·¨è™Ÿ'] || '';
                    category = row.category || row['category'] || row['é¡åˆ¥'] || row.Category || row['Category'] || '';
                    quantity = row.Quantity || row['Quantity'] || row.quantity || row['quantity'] || row['æ•¸é‡'] || row['Quantity'] || '';
                    
                    // If not found by name, use position (first, second, third column)
                    if (!id && keys.length >= 1) {
                        id = row[keys[0]] || '';
                    }
                    if (!category && keys.length >= 2) {
                        category = row[keys[1]] || '';
                    }
                    if (!quantity && keys.length >= 3) {
                        quantity = row[keys[2]] || '';
                    }
                } else if (Array.isArray(row)) {
                    // Array format: [ID, category, quantity, ...]
                    id = row[0] || '';
                    category = row[1] || '';
                    quantity = row[2] || '';
                } else {
                    id = '';
                    category = '';
                    quantity = '';
                }
                
                // Skip if all are empty
                if (!id && !category && !quantity) {
                    return;
                }
                
                // Create table row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="stock-id">${id}</td>
                    <td class="stock-category">${category}</td>
                    <td class="stock-number">${quantity}</td>
                `;
                
                stocksTableBody.appendChild(tr);
            });
        }
        
        // Function to show no data message
        function showNoData() {
            completeProgressBar();
            loadingMessage.style.display = 'none';
            const stocksTableWrapper = document.getElementById('stocksTableWrapper');
            if (stocksTableWrapper) stocksTableWrapper.style.display = 'none';
            noDataMessage.style.display = 'block';
        }
        
        // Show instructions for setting up Google Apps Script
        function showNoDataWithInstructions() {
            completeProgressBar();
            loadingMessage.style.display = 'none';
            const stocksTableWrapper = document.getElementById('stocksTableWrapper');
            if (stocksTableWrapper) stocksTableWrapper.style.display = 'none';
            noDataMessage.innerHTML = `
                <p>ç›®å‰ç„¡æ³•è®€å–æ•¸æ“š</p>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.85rem; color: #ccc; text-align: left;">
                    <p style="margin-bottom: 0.5rem;"><strong>è«‹åœ¨æ‚¨çš„ Google Apps Script ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç¢¼ï¼š</strong></p>
                    <pre style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 5px; overflow-x: auto; font-size: 0.75rem; margin: 0.5rem 0;">function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);
  
  const result = rows.map(row => {
    const obj = {};
    headers.forEach((header, i) => {
      obj[header] = row[i];
    });
    return obj;
  });
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
                    <p style="margin-top: 0.5rem; font-size: 0.8rem;">ç„¶å¾Œéƒ¨ç½²ç‚º Web æ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦è¨­ç½®åŸ·è¡Œèº«ä»½ç‚ºã€Œæˆ‘ã€ã€‚</p>
                </div>
            `;
            noDataMessage.style.display = 'block';
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchStocksData();
        });
        
        // Refresh data when page becomes visible (user switches back to this tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible, refresh data
                fetchStocksData();
            }
        });
        
        // Also refresh when page gains focus
        window.addEventListener('focus', function() {
            fetchStocksData();
        });
    </script>
</body>
</html>
