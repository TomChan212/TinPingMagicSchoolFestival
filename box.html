<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>é­”æ³•ç›’å­</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
    <div class="background-image"></div>
    <div class="overlay"></div>
    <div class="celebration-effect" id="celebrationEffect"></div>
    <div class="container">
        <div class="image-container">
            <img src="opened.png" alt="Opened Pandora Box" class="theme-image">
        </div>
        <div class="coins-container" id="coinsContainer">
            <div class="coin-clickable-wrapper" id="coinsWrapper" style="display: none;">
                <img src="Coins.png" alt="Coins" class="coins-image" id="coinsImage">
                <div class="click-me-text" id="coinsClickText">é»æ“Šæˆ‘</div>
            </div>
            <div class="coin-clickable-wrapper" id="gratecoinWrapper" style="display: none;">
                <img src="gratecoin.png" alt="Gratecoin" class="gratecoin-image" id="gratecoinImage">
                <div class="click-me-text" id="gratecoinClickText">é»æ“Šæˆ‘</div>
            </div>
        </div>
        <div class="box-reward-message">
            <h2>ğŸ‰ æ­å–œä½ ï¼</h2>
            <p id="rewardMessage">ä½ æˆåŠŸæ‰“é–‹äº†é­”æ³•ç›’å­ï¼Œç²å¾—äº†<span class="special-reward-text">ç³§é£Ÿè²¨å¹£</span>ä¸€æšä½œçš„çå‹µï¼</p>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">â¬…ï¸ è¿”å›</button>
    </div>

    <!-- Confirmation Modal -->
    <div class="coin-confirm-modal" id="coinConfirmModal">
        <div class="coin-confirm-content">
            <h2>ç¢ºèªä½¿ç”¨</h2>
            <p>ä½ ç¢ºå®šè¦ä½¿ç”¨é€™å€‹è²¨å¹£å—ï¼Ÿ</p>
            <div class="coin-confirm-buttons">
                <button class="coin-confirm-yes" id="coinConfirmYes">æ˜¯</button>
                <button class="coin-confirm-no" id="coinConfirmNo">å¦</button>
            </div>
        </div>
    </div>

    <!-- Reward Message Modal -->
    <div class="coin-reward-modal" id="coinRewardModal">
        <div class="coin-reward-content">
            <h2>ğŸ‰ æ­å–œä½ ï¼</h2>
            <p class="reward-message">æ­å–œä½ ç²å¾— "ç¥ç§˜çå‹µï¼Œè«‹<span class="special-reward-text-red">ä¿æŒé é¢</span>åˆ°æ ¡é•·å®¤é ˜å–ä½ çš„ç¦®ç‰©"</p>
            <button class="coin-reward-confirm" id="useRewardBtn">ä½¿ç”¨</button>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-content">
            <div class="scanner-header">
                <h2>æƒæäºŒç¶­ç¢¼</h2>
                <button class="close-scanner" id="closeScanner">âœ•</button>
            </div>
            <div id="qr-reader" style="width: 100%;"></div>
            <p class="scanner-hint">å°‡äºŒç¶­ç¢¼å°æº–ç›¸æ©Ÿ</p>
        </div>
    </div>

    <!-- Final Reward Modal -->
    <div class="coin-reward-modal" id="finalRewardModal">
        <div class="coin-reward-content">
            <h2>ğŸ‰ æ­å–œä½ ï¼</h2>
            <p class="reward-message" id="finalRewardMessage">æ­å–œä½ ç²å¾— items !!! è«‹ç¤ºæ„é ˜å–ã€‚</p>
            <button class="coin-reward-confirm" id="finalRewardConfirm">ç¢ºå®š</button>
        </div>
    </div>

    <!-- Loading Animation -->
    <div class="loading-animation" id="loadingAnimation" style="display: none;">
        <div class="magic-circle">
            <div class="magic-circle-inner"></div>
            <div class="magic-circle-outer"></div>
        </div>
        <p class="loading-text">åŠ è¼‰ä¸­</p>
    </div>

    <script>
        // Create celebration effect (confetti and fireworks)
        function createCelebrationEffect() {
            const celebrationContainer = document.getElementById('celebrationEffect');
            if (!celebrationContainer) return;
            
            // Clear any existing effects
            celebrationContainer.innerHTML = '';
            
            // Create confetti
            const confettiColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe'];
            const confettiCount = 100;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                celebrationContainer.appendChild(confetti);
            }
            
            // Create fireworks at multiple positions
            const fireworkPositions = [
                { x: 20, y: 30 },
                { x: 50, y: 25 },
                { x: 80, y: 30 },
                { x: 30, y: 50 },
                { x: 70, y: 50 },
                { x: 50, y: 70 }
            ];
            
            fireworkPositions.forEach((pos, index) => {
                setTimeout(() => {
                    createFirework(pos.x, pos.y, celebrationContainer);
                }, index * 200);
            });
            
            // Clean up after animation
            setTimeout(() => {
                celebrationContainer.innerHTML = '';
            }, 5000);
        }

        // Create a single firework
        function createFirework(x, y, container) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = x + '%';
            firework.style.top = y + '%';
            
            const fireworkColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe', '#ffd32a', '#ff6348'];
            
            // Create particles
            for (let i = 1; i <= 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.backgroundColor = fireworkColors[Math.floor(Math.random() * fireworkColors.length)];
                firework.appendChild(particle);
            }
            
            container.appendChild(firework);
            
            // Remove firework after animation
            setTimeout(() => {
                if (firework.parentNode) {
                    firework.parentNode.removeChild(firework);
                }
            }, 2000);
        }

        // Check achievement status and show appropriate rewards
        function checkAchievementsAndShowRewards() {
            // Check achievement status
            const prevAllRocksCollected = localStorage.getItem('prevAllRocksCollected') === 'true';
            const prevAllItemsCollected = localStorage.getItem('prevAllItemsCollected') === 'true';
            
            // Check if coins are used
            const coinsUsed = localStorage.getItem('coinsUsed') === 'true';
            const gratecoinUsed = localStorage.getItem('gratecoinUsed') === 'true';
            
            const coinsWrapper = document.getElementById('coinsWrapper');
            const gratecoinWrapper = document.getElementById('gratecoinWrapper');
            const coinsImage = document.getElementById('coinsImage');
            const gratecoinImage = document.getElementById('gratecoinImage');
            const rewardMessage = document.getElementById('rewardMessage');
            const coinsClickText = document.getElementById('coinsClickText');
            const gratecoinClickText = document.getElementById('gratecoinClickText');
            
            // Check if both achievements are completed
            if (prevAllRocksCollected && prevAllItemsCollected) {
                // Both achievements: Show only è‡³å°Šç³§é£Ÿè²¨å¹£
                if (coinsWrapper) coinsWrapper.style.display = 'none';
                if (gratecoinWrapper) gratecoinWrapper.style.display = 'block';
                if (rewardMessage) {
                    rewardMessage.innerHTML = 'æ­å–œä½ å®Œæˆäº† é­”æ³•å¤§å¸«å’Œæ¢éšªå®¶çš„æˆå°± ï¼ï¼ï¼<br>ç²å¾—äº†<span class="special-reward-text">è‡³å°Šç³§é£Ÿè²¨å¹£</span>ï¼ï¼<br>è«‹åˆ°æ ¡é•·å®¤é ˜å–ä½ çš„çå“ã€‚';
                }
                
                // Check if gratecoin is used
                if (gratecoinUsed) {
                    markCoinAsUsed('gratecoin');
                }
            } else if (prevAllRocksCollected) {
                // Only é­”æ³•å¤§å¸«æˆå°±: Show only ç³§é£Ÿè²¨å¹£
                if (coinsWrapper) coinsWrapper.style.display = 'block';
                if (gratecoinWrapper) gratecoinWrapper.style.display = 'none';
                if (rewardMessage) {
                    rewardMessage.innerHTML = 'æ­å–œä½ å®Œæˆäº† é­”æ³•å¤§å¸«çš„æˆå°± ï¼ï¼ï¼<br>ç²å¾—äº†<span class="special-reward-text">é­”æ³•ç³§é£Ÿè²¨å¹£</span>ï¼ï¼<br>è«‹åˆ°æ ¡é•·å®¤é ˜å–ä½ çš„çå“ã€‚';
                }
                
                // Check if coins is used
                if (coinsUsed) {
                    markCoinAsUsed('coins');
                }
            } else {
                // No achievements completed yet
                if (coinsWrapper) coinsWrapper.style.display = 'none';
                if (gratecoinWrapper) gratecoinWrapper.style.display = 'none';
                if (rewardMessage) {
                    rewardMessage.innerHTML = 'è«‹å…ˆå®Œæˆæˆå°±ä»¥ç²å¾—çå‹µï¼';
                }
            }
        }
        
        // Mark coin as used
        function markCoinAsUsed(coinType) {
            const coinsWrapper = document.getElementById('coinsWrapper');
            const gratecoinWrapper = document.getElementById('gratecoinWrapper');
            const coinsClickText = document.getElementById('coinsClickText');
            const gratecoinClickText = document.getElementById('gratecoinClickText');
            
            if (coinType === 'coins' && coinsWrapper && coinsClickText) {
                coinsWrapper.style.pointerEvents = 'none';
                coinsWrapper.style.opacity = '0.6';
                coinsClickText.textContent = 'å·²ä½¿ç”¨';
                coinsClickText.style.opacity = '1';
                coinsClickText.style.color = '#999';
            } else if (coinType === 'gratecoin' && gratecoinWrapper && gratecoinClickText) {
                gratecoinWrapper.style.pointerEvents = 'none';
                gratecoinWrapper.style.opacity = '0.6';
                gratecoinClickText.textContent = 'å·²ä½¿ç”¨';
                gratecoinClickText.style.opacity = '1';
                gratecoinClickText.style.color = '#999';
            }
        }

        // Trigger celebration effect when page loads
        window.addEventListener('DOMContentLoaded', function() {
            createCelebrationEffect();
            checkAchievementsAndShowRewards();
            initializeCoinInteractions();
        });

        // Initialize coin click interactions
        function initializeCoinInteractions() {
            const coinsWrapper = document.getElementById('coinsWrapper');
            const gratecoinWrapper = document.getElementById('gratecoinWrapper');
            const coinsClickText = document.getElementById('coinsClickText');
            const gratecoinClickText = document.getElementById('gratecoinClickText');
            
            // Check if coins are used
            const coinsUsed = localStorage.getItem('coinsUsed') === 'true';
            const gratecoinUsed = localStorage.getItem('gratecoinUsed') === 'true';

            // Show floating text on coins (only if not used)
            if (coinsWrapper && coinsClickText && !coinsUsed) {
                coinsClickText.style.opacity = '1';
            }
            if (gratecoinWrapper && gratecoinWrapper.style.display !== 'none' && gratecoinClickText && !gratecoinUsed) {
                gratecoinClickText.style.opacity = '1';
            }

            // Make coins clickable (only if not used)
            if (coinsWrapper && !coinsUsed) {
                coinsWrapper.addEventListener('click', function() {
                    showCoinConfirmation('coins');
                });
            }
            if (gratecoinWrapper && !gratecoinUsed) {
                gratecoinWrapper.addEventListener('click', function() {
                    if (gratecoinWrapper.style.display !== 'none') {
                        showCoinConfirmation('gratecoin');
                    }
                });
            }
        }

        // Show confirmation modal
        function showCoinConfirmation(coinType) {
            const confirmModal = document.getElementById('coinConfirmModal');
            if (confirmModal) {
                confirmModal.classList.add('active');
                currentCoinType = coinType; // Save coin type globally
            }
        }

        // Close confirmation modal
        function closeCoinConfirmation() {
            const confirmModal = document.getElementById('coinConfirmModal');
            if (confirmModal) {
                confirmModal.classList.remove('active');
            }
            // Don't clear currentCoinType here, it will be cleared after final reward
        }

        // Show reward message modal
        function showRewardMessage() {
            const rewardModal = document.getElementById('coinRewardModal');
            if (rewardModal) {
                rewardModal.classList.add('active');
            }
        }

        // Close reward message modal
        function closeRewardMessage() {
            const rewardModal = document.getElementById('coinRewardModal');
            if (rewardModal) {
                rewardModal.classList.remove('active');
            }
        }

        // QR Scanner variables
        let qrScanner = null;
        
        // Track which coin is currently being used
        let currentCoinType = null;

        // Open QR Scanner
        function openQRScanner() {
            const scannerModal = document.getElementById('scannerModal');
            if (!scannerModal) return;

            scannerModal.classList.add('active');
            
            // Initialize QR Scanner
            qrScanner = new Html5Qrcode("qr-reader");
            
            // Get viewport dimensions for responsive QR box
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const qrBoxSize = Math.min(viewportWidth * 0.8, viewportHeight * 0.5, 300);
            
            qrScanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: qrBoxSize, height: qrBoxSize },
                    aspectRatio: 1.0
                },
                (decodedText, decodedResult) => {
                    handleQRScan(decodedText);
                },
                (errorMessage) => {
                    // Error ignored for continuous scanning
                }
            ).catch((err) => {
                console.error("Unable to start scanning", err);
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š');
                closeQRScanner();
            });
        }

        // Close QR Scanner
        function closeQRScanner() {
            if (qrScanner) {
                qrScanner.stop().then(() => {
                    qrScanner.clear();
                    qrScanner = null;
                }).catch((err) => {
                    console.error("Error stopping scanner", err);
                });
            }
            const scannerModal = document.getElementById('scannerModal');
            if (scannerModal) {
                scannerModal.classList.remove('active');
            }
        }

        // Handle QR scan
        function handleQRScan(scannedText) {
            const normalizedText = scannedText.trim().toLowerCase();
            
            // Check if user has completed both achievements (for supermagic)
            const prevAllRocksCollected = localStorage.getItem('prevAllRocksCollected') === 'true';
            const prevAllItemsCollected = localStorage.getItem('prevAllItemsCollected') === 'true';
            const hasGratecoin = prevAllRocksCollected && prevAllItemsCollected;
            
            if (normalizedText === 'magic') {
                // Check if user has gratecoin (completed both achievements)
                // If has gratecoin, can only use supermagic
                if (hasGratecoin) {
                    alert('ä½ å·²å®Œæˆå…©å€‹æˆå°±ï¼Œåªèƒ½ä½¿ç”¨ supermagic äºŒç¶­ç¢¼ï¼');
                    return; // Don't close scanner, let user try again
                }
                
                // Close scanner
                closeQRScanner();
                
                // Fetch and show random item (exclude grand prizes)
                fetchRandomItem(false);
            } else if (normalizedText === 'supermagic') {
                // Check if user has gratecoin (completed both achievements)
                if (!hasGratecoin) {
                    alert('åªæœ‰å®Œæˆé­”æ³•å¤§å¸«å’Œæ¢éšªå®¶å…©å€‹æˆå°±æ‰èƒ½ä½¿ç”¨ supermagicï¼');
                    return; // Don't close scanner, let user try again
                }
                
                // Close scanner
                closeQRScanner();
                
                // Fetch and show random item (include grand prizes)
                fetchRandomItem(true);
            } else {
                alert('ç„¡æ•ˆçš„äºŒç¶­ç¢¼ï¼è«‹æƒææ­£ç¢ºçš„é­”æ³•äºŒç¶­ç¢¼ã€‚');
            }
        }

        // Grand prize IDs
        const GRAND_PRIZE_IDS = ['#002', '#003', '#007'];
        
        // Google Apps Script API URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyzrjCIe0DzHG6czweM9-rpXtC54im6V821ReV3uH0p3wSQnAZIjzE3RPRPZyUhoFZJ/exec';
        
        // Update Google Sheets quantity for a specific item
        async function updateGoogleSheetQuantity(itemId, newQuantity, remark = '') {
            const payload = {
                action: 'update',
                id: itemId,
                quantity: newQuantity,
                remark: remark
            };
            
            try {
                // Send only ONE request using JSON format
                fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(() => {
                    console.log(`âœ… å·²å³æ™‚æ›´æ–° Google Sheets: ${itemId} çš„æ•¸é‡ç‚º ${newQuantity}${remark ? ', å‚™è¨»: ' + remark : ''}`);
                })
                .catch(error => {
                    console.error('âŒ æ›´æ–° Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    // Retry once after 1 second
                    setTimeout(() => {
                        fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            cache: 'no-cache',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(() => {
                            console.log(`âœ… é‡è©¦æˆåŠŸ: å·²æ›´æ–° Google Sheets: ${itemId} çš„æ•¸é‡ç‚º ${newQuantity}`);
                        })
                        .catch(retryError => {
                            console.error('âŒ é‡è©¦å¤±æ•—:', retryError);
                        });
                    }, 1000);
                });
                
            } catch (error) {
                console.error('âŒ æ›´æ–° Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }
        
        // Show loading animation
        function showLoadingAnimation() {
            const loadingAnimation = document.getElementById('loadingAnimation');
            if (loadingAnimation) {
                loadingAnimation.style.display = 'flex';
            }
        }

        // Hide loading animation
        function hideLoadingAnimation() {
            const loadingAnimation = document.getElementById('loadingAnimation');
            if (loadingAnimation) {
                loadingAnimation.style.display = 'none';
            }
        }

        // Fetch random item from Google Sheets
        async function fetchRandomItem(includeGrandPrizes = false) {
            // Show loading animation
            showLoadingAnimation();
            
            try {
                // Use JSONP to fetch data
                const timestamp = Date.now();
                const callbackName = 'handleStocksData_' + timestamp;
                
                window[callbackName] = function(data) {
                    // Clean up
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                    
                    // Process data and select random item
                    let dataArray = [];
                    if (Array.isArray(data)) {
                        dataArray = data;
                    } else if (data.data && Array.isArray(data.data)) {
                        dataArray = data.data;
                    }
                    
                    // Filter items where quantity > 0 and create weighted list
                    const weightedItems = [];
                    const itemMap = {}; // Map category to item data (ID, category, quantity)
                    let isFallbackToRegular = false; // Track if we're falling back to regular items
                    
                    // First pass: collect items based on includeGrandPrizes flag
                    dataArray.forEach(row => {
                        let id = '';
                        let quantity = 0;
                        let category = '';
                        
                        if (typeof row === 'object' && !Array.isArray(row)) {
                            const keys = Object.keys(row);
                            id = row.ID || row['ID'] || row.id || row['id'] || row['ç·¨è™Ÿ'] || (keys.length >= 1 ? row[keys[0]] : '');
                            quantity = parseInt(row.Quantity || row['Quantity'] || row.quantity || row['quantity'] || row['æ•¸é‡'] || (keys.length >= 3 ? row[keys[2]] : 0)) || 0;
                            category = row.category || row['category'] || row['é¡åˆ¥'] || (keys.length >= 2 ? row[keys[1]] : '');
                        } else if (Array.isArray(row)) {
                            id = row[0] || '';
                            quantity = parseInt(row[2]) || 0;
                            category = row[1] || '';
                        }
                        
                        // Check if this is a grand prize
                        const isGrandPrize = GRAND_PRIZE_IDS.includes(id);
                        
                        // Skip if quantity is 0 or category is empty
                        if (quantity <= 0 || !category) {
                            return;
                        }
                        
                        if (isGrandPrize && !includeGrandPrizes) {
                            // Grand prize but not in supermagic mode - skip
                            return;
                        }
                        
                        if (!isGrandPrize && includeGrandPrizes) {
                            // Not a grand prize but in supermagic mode - skip (only grand prizes allowed in first pass)
                            return;
                        }
                        
                        // Store item data for later reference
                        if (!itemMap[category]) {
                            itemMap[category] = { id: id, category: category, quantity: quantity };
                        }
                        
                        // Add the item to weighted list based on its quantity
                        // Higher quantity = more entries in the list = higher probability
                        for (let i = 0; i < quantity; i++) {
                            weightedItems.push(category);
                        }
                    });
                    
                    // If includeGrandPrizes is true but no grand prizes available, fallback to regular items
                    if (includeGrandPrizes && weightedItems.length === 0) {
                        isFallbackToRegular = true;
                        // Second pass: collect regular items (non-grand prizes)
                        dataArray.forEach(row => {
                            let id = '';
                            let quantity = 0;
                            let category = '';
                            
                            if (typeof row === 'object' && !Array.isArray(row)) {
                                const keys = Object.keys(row);
                                id = row.ID || row['ID'] || row.id || row['id'] || row['ç·¨è™Ÿ'] || (keys.length >= 1 ? row[keys[0]] : '');
                                quantity = parseInt(row.Quantity || row['Quantity'] || row.quantity || row['quantity'] || row['æ•¸é‡'] || (keys.length >= 3 ? row[keys[2]] : 0)) || 0;
                                category = row.category || row['category'] || row['é¡åˆ¥'] || (keys.length >= 2 ? row[keys[1]] : '');
                            } else if (Array.isArray(row)) {
                                id = row[0] || '';
                                quantity = parseInt(row[2]) || 0;
                                category = row[1] || '';
                            }
                            
                            const isGrandPrize = GRAND_PRIZE_IDS.includes(id);
                            
                            // Only collect non-grand prizes with quantity > 0
                            if (quantity > 0 && category && !isGrandPrize) {
                                if (!itemMap[category]) {
                                    itemMap[category] = { id: id, category: category, quantity: quantity };
                                }
                                
                                for (let i = 0; i < quantity; i++) {
                                    weightedItems.push(category);
                                }
                            }
                        });
                    }
                    
                    // Hide loading animation
                    hideLoadingAnimation();
                    
                    if (weightedItems.length === 0) {
                        if (includeGrandPrizes) {
                            showFinalReward('ç›®å‰æ²’æœ‰å¯ç”¨çš„å¤§ç');
                        } else {
                            showFinalReward('ç›®å‰æ²’æœ‰å¯ç”¨çš„ç‰©å“');
                        }
                        return;
                    }
                    
                    // Randomly select one item from weighted list
                    const randomIndex = Math.floor(Math.random() * weightedItems.length);
                    const selectedCategory = weightedItems[randomIndex];
                    const selectedItem = itemMap[selectedCategory];
                    
                    // Update Google Sheets FIRST: decrease quantity by 1 (immediate update)
                    // This applies to both magic and supermagic scans
                    if (selectedItem && selectedItem.id) {
                        const newQuantity = Math.max(0, selectedItem.quantity - 1); // Ensure quantity doesn't go below 0
                        console.log(`ğŸ”„ æº–å‚™æ›´æ–° Google Sheets: ${selectedItem.id} (${selectedItem.category}) å¾ ${selectedItem.quantity} æ¸›è‡³ ${newQuantity}`);
                        
                        // Determine if this is a BIG prize (grand prize) or SMALL prize
                        const isGrandPrize = GRAND_PRIZE_IDS.includes(selectedItem.id);
                        const prizeType = isGrandPrize ? 'BIG' : 'SMALL';
                        
                        // Get current time in format: YYYY-MM-DD HH:MM:SS
                        const now = new Date();
                        const timeString = now.getFullYear() + '-' + 
                                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                                         String(now.getDate()).padStart(2, '0') + ' ' + 
                                         String(now.getHours()).padStart(2, '0') + ':' + 
                                         String(now.getMinutes()).padStart(2, '0') + ':' + 
                                         String(now.getSeconds()).padStart(2, '0');
                        
                        // Create remark: Time_item name_BIG/SMALL
                        const remark = timeString + '_' + selectedItem.category + '_' + prizeType;
                        
                        updateGoogleSheetQuantity(selectedItem.id, newQuantity, remark);
                    } else {
                        console.warn('âš ï¸ ç„¡æ³•æ›´æ–° Google Sheets: é¸ä¸­çš„ç‰©å“ç¼ºå°‘ ID æˆ–æ•¸æ“š');
                    }
                    
                    // Then show final reward with special message if fallback
                    if (isFallbackToRegular) {
                        showFinalRewardWithFallback(selectedCategory);
                    } else {
                        showFinalReward(selectedCategory);
                    }
                };
                
                // Create script tag for JSONP
                const script = document.createElement('script');
                script.src = scriptURL + '?action=get&callback=' + callbackName + '&_t=' + timestamp;
                script.onerror = function() {
                    // Hide loading animation
                    hideLoadingAnimation();
                    
                    delete window[callbackName];
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    showFinalReward('ç„¡æ³•è®€å–æ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦');
                };
                
                document.head.appendChild(script);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    // Hide loading animation
                    hideLoadingAnimation();
                    
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        showFinalReward('è®€å–æ•¸æ“šè¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                }, 10000);
                
            } catch (error) {
                // Hide loading animation
                hideLoadingAnimation();
                
                console.error('Error fetching data:', error);
                showFinalReward('ç„¡æ³•è®€å–æ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // Show final reward message
        function showFinalReward(itemName) {
            const finalRewardModal = document.getElementById('finalRewardModal');
            const finalRewardMessage = document.getElementById('finalRewardMessage');
            
            if (finalRewardModal && finalRewardMessage) {
                finalRewardMessage.textContent = `æ­å–œä½ ç²å¾— ${itemName} !!! è«‹ç¤ºæ„é ˜å–ã€‚`;
                finalRewardModal.classList.add('active');
            }
        }
        
        // Show final reward message with fallback message (when grand prizes are all sent out)
        function showFinalRewardWithFallback(itemName) {
            const finalRewardModal = document.getElementById('finalRewardModal');
            const finalRewardMessage = document.getElementById('finalRewardMessage');
            
            if (finalRewardModal && finalRewardMessage) {
                finalRewardMessage.textContent = `å¾ˆæŠ±æ­‰ï¼Œæ‰€æœ‰è‡³å°Šçå“å·²ç¶“ç™¼é€å®Œç•¢ï¼Œæ‚¨ç²å¾—äº†ã€Œ${itemName}ã€ï¼Œéå¸¸æ„Ÿè¬æ‚¨çš„è¸´èºåƒèˆ‡ï¼`;
                finalRewardModal.classList.add('active');
            }
        }

        // Close final reward modal
        function closeFinalReward() {
            const finalRewardModal = document.getElementById('finalRewardModal');
            if (finalRewardModal) {
                finalRewardModal.classList.remove('active');
            }
            
            // Mark the coin as used based on which coin was clicked
            if (currentCoinType) {
                if (currentCoinType === 'coins') {
                    localStorage.setItem('coinsUsed', 'true');
                    markCoinAsUsed('coins');
                } else if (currentCoinType === 'gratecoin') {
                    localStorage.setItem('gratecoinUsed', 'true');
                    markCoinAsUsed('gratecoin');
                }
                currentCoinType = null; // Clear after marking as used
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Confirmation modal buttons
            const coinConfirmYes = document.getElementById('coinConfirmYes');
            const coinConfirmNo = document.getElementById('coinConfirmNo');
            
            if (coinConfirmYes) {
                coinConfirmYes.addEventListener('click', function() {
                    closeCoinConfirmation();
                    showRewardMessage();
                });
            }
            
            if (coinConfirmNo) {
                coinConfirmNo.addEventListener('click', function() {
                    closeCoinConfirmation();
                });
            }
            
            // Reward message "ä½¿ç”¨" button
            const useRewardBtn = document.getElementById('useRewardBtn');
            if (useRewardBtn) {
                useRewardBtn.addEventListener('click', function() {
                    closeRewardMessage();
                    openQRScanner();
                });
            }
            
            // Close scanner button
            const closeScanner = document.getElementById('closeScanner');
            if (closeScanner) {
                closeScanner.addEventListener('click', function() {
                    closeQRScanner();
                });
            }
            
            // Final reward confirm button
            const finalRewardConfirm = document.getElementById('finalRewardConfirm');
            if (finalRewardConfirm) {
                finalRewardConfirm.addEventListener('click', function() {
                    closeFinalReward();
                });
            }
        });
    </script>
</body>
</html>
